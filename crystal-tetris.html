<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Crystal Tetris - AR Lite</title>
  <style>
    html, body {
      margin: 0;
      overflow: hidden;
      width: 100%;
      height: 100%;
      background: black;
    }
    video {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: -1; /* camera background */
    }
    canvas {
      width: 100%;
      height: 100%;
      display: block;
    }
    #score {
      position: fixed;
      top: 10px;
      left: 10px;
      color: white;
      font-family: sans-serif;
      font-size: 20px;
      background: rgba(0,0,0,0.5);
      padding: 5px 10px;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <video id="camera" autoplay playsinline></video>
  <div id="score">Score: 0</div>
  <canvas id="renderCanvas"></canvas>

  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>

  <script>
    const canvas = document.getElementById("renderCanvas");
    const engine = new BABYLON.Engine(canvas, true);

    // Scene setup
    const scene = new BABYLON.Scene(engine);
    const camera = new BABYLON.FreeCamera("cam", new BABYLON.Vector3(0, 5, -12), scene);
    camera.setTarget(BABYLON.Vector3.Zero());
    const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);

    // Enable device orientation camera (AR-lite)
    const deviceOrientation = new BABYLON.DeviceOrientationCamera("DevOr_camera", camera.position, scene);
    deviceOrientation.attachControl(canvas, true);
    scene.activeCamera = deviceOrientation;

    // Floor (lattice base)
    const ground = BABYLON.MeshBuilder.CreateGround("ground", {width: 10, height: 10}, scene);
    ground.position.y = 0;
    const groundMat = new BABYLON.StandardMaterial("groundMat", scene);
    groundMat.alpha = 0.2;
    groundMat.wireframe = true;
    ground.material = groundMat;

    // Crystal lattice guide (wireframe box)
    const lattice = BABYLON.MeshBuilder.CreateBox("lattice", {size: 6}, scene);
    const latticeMat = new BABYLON.StandardMaterial("latticeMat", scene);
    latticeMat.alpha = 0.1;
    latticeMat.wireframe = true;
    lattice.material = latticeMat;

    // Falling blocks
    let blocks = [];
    let score = 0;
    function spawnBlock() {
      const box = BABYLON.MeshBuilder.CreateBox("box", {size: 1}, scene);
      box.position.y = 8;
      box.position.x = Math.floor(Math.random() * 6 - 3);
      box.position.z = Math.floor(Math.random() * 6 - 3);
      const mat = new BABYLON.StandardMaterial("boxMat", scene);
      mat.diffuseColor = new BABYLON.Color3(Math.random(), Math.random(), Math.random());
      box.material = mat;
      blocks.push(box);
    }

    // Tap to drop a block
    window.addEventListener("click", spawnBlock);

    // Physics-like falling
    scene.onBeforeRenderObservable.add(() => {
      const dt = engine.getDeltaTime() / 1000;
      blocks.forEach((b) => {
        if (b.position.y > 0.5) {
          b.position.y -= 2 * dt; // fall speed
        } else {
          b.position.y = 0.5; // stop at floor
        }
      });

      // Simple scoring: 1 point per block on the floor
      score = blocks.filter(b => b.position.y <= 0.5).length;
      document.getElementById("score").innerText = "Score: " + score;
    });

    // Camera background (live video)
    const video = document.getElementById("camera");
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then((stream) => {
        video.srcObject = stream;
      });

    engine.runRenderLoop(() => scene.render());
    window.addEventListener("resize", () => engine.resize());
  </script>
</body>
</html>
