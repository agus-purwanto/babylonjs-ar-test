<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Crystal Tetris AR-lite</title>
  <style>
    html, body {
      margin: 0;
      overflow: hidden;
      width: 100%;
      height: 100%;
      background: black;
    }
    video {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: -1; /* camera background */
    }
    canvas {
      width: 100%;
      height: 100%;
      display: block;
    }
    #score {
      position: fixed;
      top: 10px;
      left: 10px;
      color: white;
      font-family: sans-serif;
      font-size: 20px;
      background: rgba(0,0,0,0.5);
      padding: 5px 10px;
      border-radius: 8px;
    }
  </style>
</head>
<body>
  <video id="camera" autoplay playsinline></video>
  <div id="score">Score: 0</div>
  <canvas id="renderCanvas"></canvas>

  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script>
    const canvas = document.getElementById("renderCanvas");
    const engine = new BABYLON.Engine(canvas, true);

    const scene = new BABYLON.Scene(engine);
    const camera = new BABYLON.FreeCamera("cam", new BABYLON.Vector3(0, 5, -12), scene);
    camera.setTarget(BABYLON.Vector3.Zero());
    const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);

    // Device orientation AR-lite camera
    const deviceOrientation = new BABYLON.DeviceOrientationCamera("DevOr_camera", camera.position, scene);
    deviceOrientation.attachControl(canvas, true);
    scene.activeCamera = deviceOrientation;

    // Ground & lattice
    const ground = BABYLON.MeshBuilder.CreateGround("ground", {width: 10, height: 10}, scene);
    const groundMat = new BABYLON.StandardMaterial("gMat", scene);
    groundMat.alpha = 0.2; groundMat.wireframe = true;
    ground.material = groundMat;

    const lattice = BABYLON.MeshBuilder.CreateBox("lattice", {size: 6}, scene);
    const latticeMat = new BABYLON.StandardMaterial("latticeMat", scene);
    latticeMat.alpha = 0.1; latticeMat.wireframe = true;
    lattice.material = latticeMat;

    // Falling block
    let activeBlock;
    let blocks = [];
    let score = 0;

    function spawnBlock() {
      const box = BABYLON.MeshBuilder.CreateBox("box", {size: 1}, scene);
      box.position.y = 8;
      box.position.x = 0;
      box.position.z = 0;
      const mat = new BABYLON.StandardMaterial("boxMat", scene);
      mat.diffuseColor = new BABYLON.Color3(Math.random(), Math.random(), Math.random());
      box.material = mat;
      activeBlock = box;
      blocks.push(box);
    }
    spawnBlock();

    // Tilt controls
    let tiltX = 0; // left/right
    let tiltZ = 0; // forward/back

    window.addEventListener("deviceorientation", (event) => {
      tiltX = event.gamma / 45; // normalize to -1..1
      tiltZ = event.beta / 45;  // normalize to -1..1
    });

    // Tap = quick drop
    window.addEventListener("click", () => {
      if (activeBlock) activeBlock.position.y -= 0.5;
    });

    scene.onBeforeRenderObservable.add(() => {
      const dt = engine.getDeltaTime() / 1000;

      if (activeBlock) {
        // Tilt-based movement
        activeBlock.position.x += tiltX * dt * 3;
        activeBlock.position.z += tiltZ * dt * 3;

        // Stay inside lattice
        activeBlock.position.x = Math.max(-3, Math.min(3, activeBlock.position.x));
        activeBlock.position.z = Math.max(-3, Math.min(3, activeBlock.position.z));

        // Gravity
        activeBlock.position.y -= dt * 2;

        // Hit ground
        if (activeBlock.position.y <= 0.5) {
          activeBlock.position.y = 0.5;
          activeBlock = null;
          score++;
          document.getElementById("score").innerText = "Score: " + score;
          spawnBlock();
        }
      }
    });

    // Camera background
    const video = document.getElementById("camera");
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then((stream) => video.srcObject = stream)
      .catch((err) => console.error("Camera error:", err));

    engine.runRenderLoop(() => scene.render());
    window.addEventListener("resize", () => engine.resize());
  </script>
</body>
</html>
